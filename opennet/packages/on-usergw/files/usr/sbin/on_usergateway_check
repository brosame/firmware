#!/bin/sh
#
# Opennet Firmware
#
# Copyright 2010 Rene Ejury <opennet@absorb.it>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#

. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


#################################################################################
# start here - with the menu
ACTION="${1:-auto}"
shift

test "$ACTION" = "--help" && echo -e "\
Usage: on_usergateway_check [OPTION]...
	usually called by cron every 5 minutes
Options:
	(no option)	do regular 5-minutely check
	checkWan	check if routes to UGW go through WAN-device, detect ping-time
	checkMtu	check if MTU of WAN-UGW-Tunnel is ok
			this test will last ~5 minutes per tunnel
			results will be stored in on-usergw config
	checkVpn	check Vpn availability of gateway on port 1600
	checkSpeed	check Speed of Gateway
	--help		this help" && exit 0


case "$ACTION" in
	checkWan|checkMtu|checkVpn|checkSpeed)
		[ "$ACTION" = checkWan ] && func=ugw_update_wan_status
		[ "$ACTION" = checkMtu ] && func=ugw_update_mtu
		[ "$ACTION" = checkVpn ] && func=ugw_update_vpn_status
		[ "$ACTION" = checkSpeed ] && func=ugw_update_speed
		if [ $# -gt 0 ]; then
			"$func" "$@"
		else
			run_for_all_openvpn_ugw "$func"
		fi
		;;
	auto)
		update_mesh_services_via_dns
		get_services "mesh" | filter_enabled_services | sort_services_by "mtu_timestamp" | while read service_name; do
			# Geschwindigkeitstest
			timestamp=$(get_service_value "$service_name" "wan_speed_timestamp" "0")
			recheck_minutes=$(get_on_usergw_default "wan_speed_recheck_period")
			is_timestamp_older_minutes "$timestamp" "$recheck_minutes" \
				&& update_public_gateway_speed_estimation "$service_name"
			# VPN-Test
			timestamp=$(get_service_value "$service_name" "vpn_timestamp" "0")
			recheck_minutes=$(get_on_usergw_default "openvpn_recheck_period")
			is_timestamp_older_minutes "$timestamp" "$recheck_minutes" \
				&& update_public_gateway_vpn_status "$service_name"
			# der MTU-Test
			timestamp=$(get_service_value "$service_name" "mtu_timestamp" "0")
			recheck_minutes=$(get_on_usergw_default "mtu_recheck_period")
			is_timestamp_older_minutes "$timestamp" "$recheck_minutes" \
				&& update_public_gateway_mtu "$service_name"
			# der WAN-Test geht schnell - es gibt keine Wartezeit
			update_service_wan_status "$service_name"
			# Gesamtstatus ermitteln
			new_status="true"
			for attribute in "wan_status" "mtu_status" "vpn_status"; do
				uci_is_true "$(get_service_value "$service_name" "$attribute" "false")" || new_status="false"
			done
			set_service_value "$service_name" "status" "$new_status"
		done
		;;
esac

