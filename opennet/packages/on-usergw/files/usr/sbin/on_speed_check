#!/bin/sh
#
# on router execute:
# for download:
# is done via apache and big file (existing .big on gateways)
# for upload:
# open firewall: iptables -I external_in -p tcp --dport 22222 -j RETURN
# (while true; do nc -l -n -p 22222 -q 0 2>&1 >/dev/null; sleep 2; done) &
# 

. "${IPKG_INSTROOT:-}/usr/bin/on-helper.sh"

UPLOAD_PORT=22222
WANDEV=$(uci_get network.wan.ifname | cut -f1 -d:)


download() {
  wget -c -O /dev/null "http://$1/.big" >/dev/null 2>&1 &
  pid=$!
  sleep 3
  [ ! -d "/proc/$pid" ] && return
  /usr/bin/ifstat -b -i "$WANDEV" 20 1 | awk 'END{print int($(NF-1)/100 + 0.5)*100}'
  kill "$pid" >/dev/null 2>&1
}

upload() {
  local nc_pid
  (cat /dev/zero | nc "$1" "$UPLOAD_PORT" >/dev/null 2>&1) &
  local pid=$!
  sleep 3
  [ ! -d "/proc/$pid" ] && return
  /usr/bin/ifstat -b -i "$WANDEV" 20 1 | awk 'END{print int($(NF)/100 + 0.5)*100}'
  # relevant process is child of pid
  for nc_pid in $(pidof nc); do
      # get parent process id
      if [ $(cut -d ' ' -f 4 "/proc/${nc_pid}/stat") = $pid ]; then
        kill "$nc_pid" >/dev/null 2>&1 || true
	break
      fi
  done
}
