#!/bin/sh
#
# Setzen aller fuer Opennet relevanten olsr-Einstellungen.
#
# Dieses Skript wird nur ein einziges Mal nach einem Upgrade oder der Erstinstallation ausgefuehrt:
#   http://wiki.openwrt.org/doc/uci#defaults
#

set -eu

. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


configure_olsrd_httpinfo_port() {
	trap "error_trap configure_olsrd_httpinfo_port '$*'" $GUARD_TRAPS
	local port="$1"
	local uci_prefix

	# add and activate httpinfo plugin
	uci_prefix=$(get_and_enable_olsrd_library_uci_prefix "httpinfo")
	# Wir koennen leider nicht zwischen "Nutzer hat 1978 eingestellt" und "Auslieferungszustand" unterscheiden.
	# Falls der Nutzer also explizit diesen Port will, dann muss er ihn nach einem Upgrade wieder einstellen.
	[ "$(uci_get "${uci_prefix}.port" "1978")" = "1978" ] && uci set "${uci_prefix}.port=8080"
	return 0
}


# das jsoninfo-Modul ist notwendig fuer die luci-Integration von olsrd
# (nett, aber unwichtig)
olsrd_enable_jsoninfo() {
	trap "error_trap olsrd_enable_jsoninfo '$*'" $GUARD_TRAPS
	local uci_prefix

	# add and activate jsoninfo plugin
	uci_prefix=$(get_and_enable_olsrd_library_uci_prefix "jsoninfo")
	uci set "${uci_prefix}.ignore=0"
}


# erwuenschte Einstellungen setzen
enable_ondataservice
enable_nameservice
disable_missing_olsr_modules
olsr_set_main_ip
olsr_set_routing_tables olsrd olsrd-default
configure_olsrd_httpinfo_port 8080
olsrd_enable_jsoninfo

apply_changes olsrd

