#!/bin/sh
#
# Konfiguriere opkg-relevante Einstellungen
#
# Dieses Skript wird nur ein einziges Mal nach einem Upgrade oder der Erstinstallation ausgefuehrt:
#   http://wiki.openwrt.org/doc/uci#defaults
#


. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


# opkg-Repository-URL an lokale Version anpassen
# Da die opkg.conf von openwrt als Konfigurationsdatei betrachtet wird, wird diese bei einer
# Aktualisierung unter Beibehaltung der Konfiguration nicht an die neuen URLs angepasst:
#  https://dev.openwrt.org/ticket/13309
# Also erledigen wir die Anpassung bei der Erstinitialisierung selbst.
override_opkg_repository_url() {
	local firmware_version=$(get_on_firmware_version)
	# leere Versionsnummer? Damit k√∂nnen wir nichts anfangen.
	[ -z "$firmware_version" ] && msg_error "Failed to retrieve opennet firmware version for opkg repository URL" && return 0
	# snapshots erkennen wir aktuell daran, dass auch Buchstaben in der Versionsnummer vorkommen
	if echo "$firmware_version" | grep -q "[a-zA-Z]"; then
		# ein Buchstabe wurde entdeckt: unstable
		set_opkg_download_version "testing/$firmware_version"
	else
		# kein Buchstabe wurde entdeckt: stable
		# wir schneiden alles ab dem ersten Bindestrich ab
		set_opkg_download_version "stable/$(echo "$firmware_version" | cut -f 1 -d -)"
	fi
}


override_opkg_repository_url

