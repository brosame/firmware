#!/bin/sh
#
# Dieses Skript wird nur ein einziges Mal nach einem Upgrade oder der Erstinstallation ausgefuehrt:
#   http://wiki.openwrt.org/doc/uci#defaults
#

set -eu

. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


# Die Einstellungen "use_olsrd_dns" und "use_olsrd_ntp" sind mit v0.5 hinzugekommen.
add_use_settings() {
	prepare_on_uci_settings
	# erzeuge die services-Node, falls noetig
	for setting in use_olsrd_dns use_olsrd_ntp; do
		uci show on-core | grep -q "^on-core\.settings\.$setting=" && continue
		uci set "on-core.settings.$setting=1"
	done
	apply_changes on-core
}


# cron-Logging abschalten (bis auf Fehlermeldungen)
# siehe http://wiki.openwrt.org/doc/uci/system#system
disable_cron_logging() {
	uci set "system.@system[0].cronloglevel=9"
	apply_changes system
}


# die Namensaufloesung im Opennet generiert auch 192.168er-Adressen - diese werden durch "rebind_protection" blockiert
disable_dnsmasq_rebind_protection() {
	uci set "dhcp.@dnsmasq[0].rebind_protection=0"
	apply_changes dhcp
}


_add_crontab_entry_if_missing() {
	local file="$1"
	local time="$2"
	local command="$3"
	local line
	while read line; do
		# Wurde die Zeile gefunden? Sofort mit Erfolg abbrechen ...
		[ "$line" != "${line%$command}" ] && return 0 || true
	done <"$file"
	# es gab keinen Treffer - wir fuegen die Zeile hinzu
	echo -e "$time\t$command" >>"$file"
}

add_crontab_entries() {
	local crontab_file=/etc/crontabs/root
	# wir wollen anschliessend pruefen, welche Zeilen vorhanden sind - also notfalls eine leere Datei anlegen
	[ -e "$crontab_file" ] || touch "$crontab_file"
	_add_crontab_entry_if_missing "$crontab_file" "* * * * *"	"run-parts /etc/cron.minutely"
	_add_crontab_entry_if_missing "$crontab_file" "*/5 * * * *"	"run-parts /etc/cron.5mins"
	_add_crontab_entry_if_missing "$crontab_file" "02 4 * * *"	"run-parts /etc/cron.daily"
}


add_use_settings
disable_cron_logging
disable_dnsmasq_rebind_protection
add_crontab_entries

