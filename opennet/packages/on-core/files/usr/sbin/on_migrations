#!/bin/sh
#
# Dieses Skript enthaelt Funktionen, die fuer Updates altes Firmware-Versionen notwendig sind.
# Alle Funktionen muessen idempotent sein.
#

set -eu


# bis Version v0.4-5: openvpn.opennet_user.comp_lzo=1
# seit Version v0.5 muss die Einstellung einen der folgenden Werte haben: yes/no/adaptive
# Wir ersetzen 1 durch "yes" und 0 durch "no"
# Status in v0.4-5:
#   ~# uci show|grep lzo
#   on-usergw.opennet_ugw.comp_lzo=1
#   openvpn.opennet_user.comp_lzo=1
#   openvpn.opennet_ugw_erina_on_i_de.comp_lzo=1
#   openvpn.opennet_ugw_subaru_on_i_de.comp_lzo=1
coerce_openvpn_comp_lzo() {
	local new_value
	local key
	local ugw_state=$(uci -q get on-usergw.opennet_ugw.comp_lzo)
	[ "$ugw_state" = 1 ] && uci set on-usergw.opennet_ugw.comp_lzo=yes
	[ "$ugw_state" = 0 ] && uci set on-usergw.opennet_ugw.comp_lzo=no
	uci show openvpn | grep "\.comp_lzo=[01]$" | while read line; do
		new_value=no
		echo "$line" | grep -q "1$" && new_value=yes
		key=$(echo "$line" | cut -f 1 -d =)
		uci set "$key=$new_value"
	done
	uci commit on-usergw
	uci commit openvpn
}


# bis Version v0.4-5: die Opennet-Firmware hat die /etc/passwd durch einen Symlink auf /etc/etc_preset/passwd ersetzt
# Bei einem Update wird das symlink-Ziel ersetzt und somit gibt es keine Nutzerdatenbank mehr.
# Dies verhindert jeden telnet/ssh-Login-Versuch. Lediglich das Web-Interface ist nutzbar.
fix_passwd_broken_symlink() {
	local target=/etc/passwd
	if [ -h "$target" -a ! -e "$target" ]; then
		rm "$target"
		cat >"$target" <<- EOF
			root:x:0:0:root:/root:/bin/ash
			daemon:*:1:1:daemon:/var:/bin/false
			ftp:*:55:55:ftp:/home/ftp:/bin/false
			network:*:101:101:network:/var:/bin/false
			nobody:*:65534:65534:nobody:/var:/bin/false
EOF
	fi
}


coerce_openvpn_comp_lzo
fix_passwd_broken_symlink

