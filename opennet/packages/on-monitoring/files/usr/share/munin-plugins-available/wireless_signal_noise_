#!/bin/sh
#
# Show currently used channel of wifi enabled devices.
# Author: Lars Kruse, devel@sumpfralle.de
# License: GPL v3 or later
#
# Requirements:
#  * "iwinfo" tool
#  * root privileges (for "iw" and "iwinfo")
#
# Magic markers
#%# capabilities=autoconf suggest
#%# family=auto


set -eu


clean_fieldname() {
	echo "$1" | sed 's/^\([^A-Za-z_]\)/_\1/; s/[^A-Za-z0-9_]/_/g'
}


get_wifi_interfaces() {
	iwinfo | grep "^[a-zA-Z]" | awk '{print $1}'
}

get_wifi_peers() {
	# return MAC of peer, signal and noise
	iwinfo "$1" assoclist | grep "^[0-9a-fA-F]" | awk '{print $1,$2,$5}'
}

get_ip_for_mac() {
	local ip
	ip=$(grep -iw "$1" /proc/net/arp | awk '{print $1}' | sort | head -1)
	[ -n "$ip" ] && echo "$ip" && return 0
	# no IP found - return MAC instead
	echo "$1"
}

get_min_signal() {
	get_wifi_peers "$1" | awk '{print $2}' | sort -n | head -1
}

get_max_noise() {
	get_wifi_peers "$1" | awk '{print $3}' | sort -n | tail -1
}

get_selected_interface() {
	# filename ends with "_"? Exit script with error immediately.
	[ "$0" != "${0%_}" ] && echo >&2 "Failed to parse wifi interface from filename" && exit 1
	# pick the last segment after the final "_"
	echo "$0" | sed 's/.*_//'
}


ACTION="${1:-}"

case "$ACTION" in
	config)
		wifi=$(get_selected_interface)
		echo "multigraph signal_quality"
		echo "graph_title Wireless signal quality - $wifi"
		echo "graph_args --upper-limit 0"
		echo "graph_vlabel Signal and noise [dBm]"
		echo "graph_category network"
		echo "graph_info This graph shows the worst signal and noise of all wifi peers"
		echo "noise.label Worst noise"
		echo "noise.draw AREA"
		echo "signal.label Worst signal"
		echo "signal.draw AREA"
		echo
		# sub graphs for all peers
		get_wifi_peers "$wifi" | while read mac details; do
			fieldname=$(clean_fieldname "peer_${mac}")
			peer=$(get_ip_for_mac "$mac")
			echo "multigraph signal_quality.$fieldname"
			echo "graph_title Peer $peer"
			echo "graph_args --upper-limit 0"
			echo "graph_vlabel Signal and noise [dBm]"
			echo "graph_category network"
			echo "noise.label Noise"
			echo "noise.draw AREA"
			echo "signal.label Signal"
			echo "signal.draw AREA"
			echo
		done
		;;
	autoconf)
		[ -z "$(get_wifi_interfaces)" ] && echo "no (no wifi interfaces found)" && exit 1
		echo "yes"
		exit 0
		;;
	suggest)
		get_wifi_interfaces
		;;
	"")
		wifi=$(get_selected_interface)
		echo "multigraph signal_quality"
		max_noise=$(get_max_noise "$wifi")
		[ -n "$max_noise" ] && echo "noise.value $max_noise"
		min_signal=$(get_min_signal "$wifi")
		[ -n "$min_signal" ] && echo "signal.value $min_signal"
		echo
		get_wifi_peers "$wifi" | while read mac signal noise; do
			# ignore empty datasets
			[ -z "$signal$noise" ] && continue
			fieldname=$(clean_fieldname "peer_${mac}")
			peer=$(get_ip_for_mac "$mac")
			echo "multigraph signal_quality.$fieldname"
			echo "noise.value $noise"
			echo "signal.value $signal"
			echo
		done
		;;
	*)
		echo >&2 "Invalid action (valid: config)"
		echo >&2
		;;
esac
