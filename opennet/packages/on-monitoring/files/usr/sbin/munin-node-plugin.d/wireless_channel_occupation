#!/bin/sh
#
# monitor the channel occupation (taken from "iw dev wlan0 survey dump")
#

set -eu


clean_fieldname() {
	echo "$1" | sed 's/^\([^A-Za-z_]\)/_\1/; s/[^A-Za-z0-9_]/_/g'
}


get_wifi_devices() {
	iw dev | grep Interface | awk '{print $2}'
}


if [ "${1:-}" = "config" ]; then
	echo "graph_title Channel Occupation"
	echo "graph_vlabel %"
	echo "graph_category wireless"
	echo "graph_args --base 1000 -r --lower-limit 0 --upper-limit 100"
	get_wifi_devices | while read device; do
		# active: listening time on this channel (usually: 5 minutes = 300000ms)
		echo "${device}_active.label Transmit"
		echo "${device}_active.type DERIVE"
		echo "${device}_active.graph no"

		# busy = receive + transmit + unknown
		echo "${device}_busy.label unknown"
		echo "${device}_busy.type DERIVE"
		echo "${device}_busy.draw AREA"
		echo "${device}_busy.cdef 100,1,${device}_active,${device}_busy,${device}_receive,${device}_transmit,+,-,/,/,*"

		# receive: this radio receives traffic for itself
		echo "${device}_receive.label Receive"
		echo "${device}_receive.type DERIVE"
		echo "${device}_receive.draw STACK"
		echo "${device}_receive.cdef 100,${device}_receive,${device}_active,/,*"

		# transmit: this radio transmits traffic
		echo "${device}_transmit.label Transmit"
		echo "${device}_transmit.type DERIVE"
		echo "${device}_transmit.draw STACK"
		echo "${device}_transmit.cdef 100,${device}_transmit,${device}_active,/,*"
	done
	exit 0
fi


get_wifi_devices | while read device; do
	iw dev "$device" survey dump \
		| grep -F -A 5 "[in use]" \
		| grep -E "channel (busy|receive|transmit|active) time:" \
		| awk '{print "'${device}_'"$2"'.value'",$4}'
done
