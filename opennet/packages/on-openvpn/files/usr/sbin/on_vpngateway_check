#!/bin/sh
#
# Opennet Firmware
#
# Copyright 2010 Rene Ejury <opennet@absorb.it>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# 	http://www.apache.org/licenses/LICENSE-2.0
#


# include helper functions
. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


PID_FILE=/var/run/on_vpngateway_check.pid
OVPN_MSG_FILE=/tmp/openvpn_msg.txt


#################################################################################
# initialization to prevent two instances running at the same time
# If interrupted, remove pid-file and set a mark in log
USER_INTERRUPT=13
trap "rm -f $PID_FILE; logger -t on_vpngateway_check[$$] was killed by another instance; exit $USER_INTERRUPT" TERM INT

# check if other instance is running, if yes, kill other instance (after a grace period for long running processes)
msg_debug "starting another instance ($@)"
clean_stale_pid_file "$PID_FILE"
aquire_lock "$PID_FILE" 3 || { msg_info "older $(basename "$0") process discovered, but it is too young: leaving it alone"; exit 0; }
echo "$$" >"$PID_FILE"
#################################################################################


case "${1:-}" in
	test)
		shift
		if [ "$#" -gt 0 ]; then
			# filtere die Dienste, die mit der einen angegebenen IP assoziiert sind
			get_services "gw" | filter_services_by_value "host=$1"
		else
			get_services "gw"
		fi | filter_reachable_services | filter_enabled_services | while read service_name; do
			description=$(get_service_description "$service_name")
			echo "Testing Gateway: $description"
			reset_mig_connection_test_timestamp "$service_name"
			test_mig_connection "$service_name" && echo "OK" || echo "FEHLER"
		 done
		find_and_select_best_gateway
		;;
	help|--help)
		echo "Usage: $(basename "$0")  [ACTION] [ARGUMENTS]"
		echo "	list:"
		echo "		show the list of all gateways, their status and the age of their last test"
		echo
		echo "	test [GW_ID [GW_ID [..]]]:"
		echo "		force a test the given gateways (if empty: all gateways) immediately"
		echo
		echo "	/default/:"
		echo "		usually called via cronjob: update gateways, test all gateways and restart openvpn"
		echo
		;;
	auto|*)
		# erster Schritt: alte Verbindungen loeschen
		cleanup_stale_openvpn_services
		# die Gateway-Tests sind nur moeglich, falls ein Test-Schluessel vorhanden ist
		if [ -e "$VPN_DIR_TEST/on_aps.crt" -a -e "$VPN_DIR_TEST/on_aps.key" ]; then
			# teste alle VPN-Verbindungen (falls noetig und moeglich)
			get_services "gw" | filter_reachable_services | filter_enabled_services | while read service_name; do
				test_mig_connection "$service_name" || true
			done
			# der Gateway-Wechsel findet nur statt, falls Schluessel und Zertifikat vorhanden sind
			has_mig_openvpn_credentials && find_and_select_best_gateway || true
		fi
		;;
esac

# remove registration
rm -f "$PID_FILE"
msg_debug "finishing another instance"

