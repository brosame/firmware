<%#
Opennet Firmware

Copyright 2010 Rene Ejury <opennet@absorb.it>
Copyright 2014 Lars Kruse <devel@sumpfralle.de>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

-%>

<%
	require("luci.model.opennet.funcs")
%>

<%+header%>
<h2><a id="content" name="content"><%:Opennet OpenVPN Gateways%></a></h2>
	<div class="cbi-map">
		<fieldset class="cbi-section">
			<div class="cbi-value-comment">
			<%:Here you can configure the IP-Addresses of your choosen Gateways.%>
			<% if show_more_info then %>
				<br /><br />
			<%	print(luci.i18n.string([[If you like to find more Information about the Gateways in Opennet, have a look in the Opennet-Wiki. Usually the first found Gateway in your list is the one you are going to use. The Gateway will be changed without your action, if the current Gateway does not work for around 6 minutes. Any Change of your Gateway will drop all your Internet Connections.<br />If none of the Gateways in your list is reachable or working (or if your list is empty), OpenVPN is deactivated. <br />Automated Gateway Search: The Gateways will be detected by an internal algorithm and ordered by their distance. In special cases this might not be the best solution.<br/><br/>Additional Information about the column-values.<br/>If any Gateway is active, then the test-connection to the OpenVPN-Service of this server was successful. If this information is missing, the test was not done yet.]]))
			else %>
				<form method="post" action="<%=REQUEST_URI%>">
					<input type="submit" name="show_more_info" class="cbi-button-plain" value="<%:...more Information...%>" />
				</form>
			<% end %>
			</div>
		</fieldset>
	</div>

<h3><%:Gateway-List%></h3>
	<div class="cbi-map">
		<fieldset class="cbi-section">
			<fieldset class="cbi-section-node">
				<% local sorting = on_function("get_service_sorting") %>
				<form name="gateways" method="post" action="<%=REQUEST_URI%>">
				<table class="cbi-section-table">
				<tr class="cbi-section-table-titles">
						<th colspan = "1" />
						<th class="cbi-section-table-cell"><%:active%></th>
						<th class="cbi-section-table-cell"><% print(luci.i18n.string([[<abbr title='click to choose immediately as your gateway'>IP-Address</abbr>]])) %></th>
						<th class="cbi-section-table-cell"><%
						if sorting ~= "manual" then
							print(luci.i18n.string([[(<abbr title='This offset is added to the values before use/display'>Offset</abbr>)]]))
							if sorting == "hop_count" then
								print(luci.i18n.string([[<abbr title='Number of Hops to the Gateway'>Distance</abbr>]]))
							else
								print(luci.i18n.string([[<abbr title='Expected Transmission Count - Quality of the Connection to the Gateway regarding OLSR'>ETX</abbr>]]))
							end
						end %>
						</th>
                        
						<th class="cbi-section-table-cell"><% print(luci.i18n.string([[<abbr title='Announced Upload / Download Speed.'>Speed</abbr>]])) %></th>

						<th class="cbi-section-table-cell"><%:VPN-Status%></th>
						<th class="cbi-section-table-cell"><%:Test-Age%></th>
						<th class="cbi-section-table-cell"><%:Actions%></th>
						<th />
				</tr>
				<%
				local service_name
				local name
				local remote
				local port
				local active
				local is_disabled
				local distance
				local offset=0
				local best_working
				local current_gw
				local index = 1
				local usable
				function bool_to_yn(bool) if bool then return "y" else return "n" end end
				for service_name in string.gmatch(on_function("get_sorted_services", "'gw' 'ugw'"), "%S+") do
					remote = get_service_value(service_name, "host")
					port = get_service_value(service_name, "port")
					if port ~= "1600" then
						remote = remote..":"..port
					end
					usable = uci_is_true(get_service_value(service_name, "status"))
					if usable and not best_working then
						best_working = service_name
					end
					if on_bool_function("is_openvpn_service_active", service_name) then
						current_gw = service_name
						if nixio.fs.access("/tmp/openvpn_msg.txt") then active="y" else active="n" end
					else
						active = nil
					end
					is_disabled = uci_is_true(get_service_value(service_name, "disabled", "false"))
					if (sorting == "etx") or (sorting == "hop") then
						offset = tonumber(get_service_value(service_name, "offset", "0"))
						if sorting == "etx" then
							distance = get_service_value(service_name, "distance")
							-- if distance then distance = string.format("%.3f", tonumber(distance)) end
						else
							distance = get_service_value(service_name, "hop_count")
							-- if distance then distance = string.format("%d", tonumber(distance)) end
						end
					else
						distance = ""
					end %>

					<tr id="cbi-network-lan" class="cbi-section-table-row" disabled="<%=bool_to_yn(is_disabled)%>">
						<td class="cbi-value-field"><div id="cbi-network-lan-count"><%=index%></div></td>
						<td class="cbi-value-field"><div id="cbi-network-lan-active" active="<%=active%>">&nbsp;</div>
						<!-- Name -->
						<th><%=remote%></th>
						<!-- Entfernung -->
						<td class="cbi-value-field"><div id="cbi-network-lan-hopcount">
							<% if distance and offset ~= 0 then %>
								(<%=offset%>)<input
									class="cbi-button cbi-button-reset cbi-button-small"
									type="submit" value="<%=service_name%>"
									title="<%:reset offset%>" name="reset_offset" />
							<% end %>
							<%=distance%>
							</div>
						</td>
						<!-- Upload / Download -->
						<td><%
							local upload = get_service_detail(service_name, "upload")
							local download = get_service_detail(service_name, "download")
							if upload or download then
								local speed = (upload or "?").." kbps / "..(download or "?").." kbps"
								local abbr = luci.i18n.stringf([[upload to Internet %s kbit/s; download from Internet %s kbit/s]], upload, download)
								io.write([[<div class="vpn-wan-speed" name="speed" id="cbi-network-lan-speed" ><abbr title="]]..abbr..[[">]]..speed..[[</abbr></div>]])
							end %>
						</td>

						<td class="cbi-value-field"><div id="cbi-network-lan-status" status="<%=get_service_value(service_name, "status") %>">&nbsp;</div></td>
						<td class="cbi-value-field"><div id="cbi-network-lan-age"><%=get_service_age(service_name) %></div></td>
						<td class="cbi-value-field"><div id="cbi-network-on-actions">
						<% if is_disabled then %>
							<input class="cbi-button cbi-button-enable cbi-button-small" type="submit" value="<%=service_name%>" title="<%:enable%>" name="enable_service" />
						<% else %>
							<input class="cbi-button cbi-button-top cbi-button-small" type="submit" value="<%=service_name%>" title="<%:move to top and connect immediately%>" name="move_top" />
							<input class="cbi-button cbi-button-up cbi-button-small" type="submit" value="<%=service_name%>" title="<%:move up%>" name="move_up" />
							<input class="cbi-button cbi-button-down cbi-button-small" type="submit" value="<%=service_name%>" title="<%:move down%>" name="move_down" />
							<input class="cbi-button cbi-button-del cbi-button-small" type="submit" value="<%=service_name%>" title="<%:delete%>" name="delete_service" />
							<input class="cbi-button cbi-button-disable cbi-button-small" type="submit" value="<%=service_name%>" title="<%:disable%>" name="disable_service" />
						<% end %>
						</div>
					</tr>
					<% index = index + 1
				end %>
				<!-- Fusszeile -->
				<tr id="cbi-network-lan" class="cbi-section-table-row">
					<td colspan="6" />
					<td class="cbi-value-field"><input class="cbi-button" type="submit" name="reset_connection_test_timestamps" value="<%:reset test counter%>" /></td>
					<td />
				</tr>
				</table>
				</form>
				<% if current_gw ~= best_working then 
					print(luci.i18n.stringf([[The first reachable and not blocked Gateway is not the current active one. The Tunnel will be restarted and the Gateway will be changed in a few minutes. The changes will be shown after a reload of this page.]]))
				end %>
			</fieldset>
		</fieldset>
	</div>
<%+footer%>
