#!/bin/sh

set -eu

. "${IPKG_INSTROOT:-}/usr/lib/opennet/on-helper.sh"


configure_tunnel_network() {
	local uci_prefix=network.on_vpn

	# Abbruch falls das Netzwerk schon vorhanden ist
	[ -n "$(uci_get "$uci_prefix")" ] && return

	# add new network to configuration (to be recognized by olsrd)
	uci set "${uci_prefix}=interface"
	uci set "${uci_prefix}.proto=none"
	uci set "${uci_prefix}.ifname=tun0"

	apply_changes network
}


configure_tunnel_firewall() {
	local uci_prefix=$(find_first_uci_section firewall zone "name=$ZONE_TUNNEL")

	# Abbruch falls die Zone bereits vorhanden ist
	[ -n "$(uci_get "$uci_prefix")" ] && return

	# Zone fuer ausgehenden Verkehr definieren
	# TODO: genuegt nicht einfach die WAN-Zone?
	uci_prefix=firewall.$(uci add firewall zone)
	uci set "${uci_prefix}.name=$ZONE_TUNNEL"
	uci set "${uci_prefix}.network=$NETWORK_TUNNEL"
	uci set "${uci_prefix}.forward=REJECT"
	uci set "${uci_prefix}.input=REJECT"
	uci set "${uci_prefix}.output=ACCEPT"
	uci set "${uci_prefix}.masq=1"

	# Weiterleitung aus dem lokalen Netzwerk heraus erlauben
	uci_prefix=firewall.$(uci add firewall forwarding)
	uci set "firewall.${section}.src=$ZONE_LOCAL"
	uci set "firewall.${section}.dest=$ZONE_TUNNEL"

	apply_changes firewall
}


# bis Version 4.5 verwendeten wir vollstaendige uci-Sektionen fuer die VPN-Server
# z.B. openvpn.opennet_user
remove_tunnel_openvpn_settings() {
	local uci_prefix=openvpn.opennet_user

	# Abbruch falls die Einstellungen bereits entfernt wurden
	[ -z "$(uci_get "$uci_prefix")" ] && return
	uci delete "$uci_prefix"
	uci commit openvpn
}


configure_tunnel_network
configure_tunnel_firewall
remove_tunnel_openvpn_settings

